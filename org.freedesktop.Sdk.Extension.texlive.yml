id: org.freedesktop.Sdk.Extension.texlive
branch: '20.08'
runtime: org.freedesktop.Sdk
build-extension: true
sdk: org.freedesktop.Sdk
runtime-version: '20.08'
appstream-compose: false
separate-locales: false
build-options:
  prefix: /usr/lib/sdk/texlive
  prepend-path: /usr/lib/sdk/texlive/bin
  arch:
    x86_64:
      prepend-path: /usr/lib/sdk/texlive/bin/x86_64-linux
    aarch64:
      prepend-path: /usr/lib/sdk/texlive/bin/aarch64-linux
modules:
  - name: texlive-texmf
    buildsystem: simple
    build-commands:
      - tar -xf texlive-20200406-texmf.tar.xz -C ${FLATPAK_DEST} --strip-components=1
    sources:
      - type: file
        url: https://ftp.tu-chemnitz.de/pub/tug/historic/systems/texlive/2020/texlive-20200406-texmf.tar.xz
        sha256: 0aa97e583ecfd488e1dc60ff049fec073c1e22dfe7de30a3e4e8c851bb875a95
  - name: texlive-source
    buildsystem: autotools
    builddir: true
    build-options:
      ldflags: -ldl
    config-opts:
      - --bindir=${FLATPAK_DEST}/bin/${FLATPAK_ARCH}-linux
      - --without-x # needs additonal dependencies
      - --disable-native-texlive-build
      - --with-system-cairo
      - --with-system-fontconfig
      - --with-system-freetype2
      - --with-system-gmp
      - --with-system-graphite2
      - --with-system-harfbuzz
      - --with-system-icu
      - --with-system-libpng
      - --with-system-pixman
      - --with-system-zlib
    post-install:
      - make texlinks
      - install -d ${FLATPAK_DEST}/tlpkg/TeXLive
      - install -m644 ../texk/tests/TeXLive/* ${FLATPAK_DEST}/tlpkg/TeXLive
      - tar -xf ../texlive-20200406-tlpdb-full.tar.gz -C ${FLATPAK_DEST}/tlpkg
      - mktexlsr
      - fmtutil-sys --all
      - mtxrun --generate
    # Hints for a proper installation can be found in http://www.linuxfromscratch.org/blfs/view/svn/pst/texlive.html or http://ftp.math.utah.edu/pub/texlive-utah/ .
    sources:
      - type: archive
        url: https://ftp.tu-chemnitz.de/pub/tug/historic/systems/texlive/2020/texlive-20200406-source.tar.xz
        sha256: e32f3d08cbbbcf21d8d3f96f2143b64a1f5e4cb01b06b761d6249c8785249078
      - type: file
        url: https://ftp.tu-chemnitz.de/pub/tug/historic/systems/texlive/2020/texlive-20200406-tlpdb-full.tar.gz
        sha256: 2990a8d275506c297b2239a1b4c5d9a9ec0d18cf12ff9a6a33924cf2e3838ed4
  - name: ghostscript
    config-opts:
    - --enable-dynamic
    - --disable-cups
    - --disable-dbus
    - --disable-gtk
    - --with-drivers=FILES
    make-args:
    - so
    make-install-args:
    - soinstall
    - install
    sources:
    - type: archive
      url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9533/ghostscript-9.53.3.tar.xz
      sha256: 9c9f5bc85b6c7eb08368c05b1e3339f7aaf9677ddca710c6283f872d55e2a234
    cleanup:
    - /share/doc
    - /share/man
    - /share/ghostscript/9.53.3/doc
    - /share/ghostscript/9.53.3/examples
  - name: asymptote
    config-opts:
      - --bindir=${FLATPAK_DEST}/bin/${FLATPAK_ARCH}-linux
      - --with-latex=${FLATPAK_DEST}/texmf-dist/tex/latex
      - --with-context=${FLATPAK_DEST}/texmf-dist/tex/context/third
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/asymptote/asymptote-2.68.src.tgz
        sha256: e1e85a5db14dc809a43189f85415bd0845bcb9eec7aea5533767838d045b02b2
  - name: woff2
    buildsystem: cmake-ninja
    builddir: true
    sources:
        - type: archive
          url: https://github.com/google/woff2/archive/v1.0.2.tar.gz
          sha256: add272bb09e6384a4833ffca4896350fdb16e0ca22df68c0384773c67a175594
  - name: dvisvgm
    buildsystem: autotools
    build-options:
      cxxflags: -I/usr/lib/sdk/texlive/include
      cflags: -I/usr/lib/sdk/texlive/include
      ldflags: -L/usr/lib/sdk/texlive/lib
      env:
        PKG_CONFIG_PATH: /usr/lib/sdk/texlive/lib/pkgconfig
    config-opts:
      - --bindir=${FLATPAK_DEST}/bin/${FLATPAK_ARCH}-linux
    sources:
      - type: archive
        url: https://github.com/mgieseki/dvisvgm/releases/download/2.10.1/dvisvgm-2.10.1.tar.gz
        md5: e1fa5d5ce656fedcdb7cd4146220e181
  - name: clisp
    sources:
    - type: archive
      url: https://ftp.gnu.org/gnu/clisp/latest/clisp-2.49.tar.bz2
      sha256: 8132ff353afaa70e6b19367a25ae3d5a43627279c25647c220641fed00f8e890
  - name: xindy
    config-opts:
    - --bindir=${FLATPAK_DEST}/bin/${FLATPAK_ARCH}-linux
    - --datarootdir=${FLATPAK_DEST}
    - --libdir=${FLATPAK_DEST}/texmf-dist
    - --mandir=${FLATPAK_DEST}/texmf-dist/doc/man
    sources:
    - type: archive
      url: http://mirrors.ctan.org/indexing/xindy/base/xindy-2.5.1.tar.gz
      sha256: 2c8ee91db7217b5776b1ee5272dd259686f7ba3ec1d25c678f75a6c03fe9ba43        
  - name: appdata
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/appdata
      - cp org.freedesktop.Sdk.Extension.texlive.appdata.xml ${FLATPAK_DEST}/share/appdata
      - appstream-compose  --basename=org.freedesktop.Sdk.Extension.texlive --prefix=${FLATPAK_DEST} --origin=flatpak org.freedesktop.Sdk.Extension.texlive
    sources:
      - type: file
        path: org.freedesktop.Sdk.Extension.texlive.appdata.xml
  - name: scripts
    buildsystem: simple
    build-commands:
      - cp *.sh /usr/lib/sdk/texlive/
    sources:
      - type: script
        commands:
          - install -d ${FLATPAK_DEST}
          - cp -ra /usr/lib/sdk/texlive/* ${FLATPAK_DEST}
        dest-filename: install.sh
      - type: script
        commands:
          - export PATH=/usr/lib/sdk/texlive/bin/${FLATPAK_ARCH}-linux:/usr/lib/sdk/texlive/bin:$PATH
        dest-filename: enable.sh
